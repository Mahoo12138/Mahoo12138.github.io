<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>香橙派 5P Ubuntu 22.04 安装 Home Assistant Supervised [ Mahoo12138 ]</title><link rel="stylesheet" href="/css/index.css"><meta name="post"><link rel="stylesheet" href="/css/layouts/post.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="hexo-container"><header></header><main id="content"><article id="post"><h1>香橙派 5P Ubuntu 22.04 安装 Home Assistant Supervised</h1><p>一切的起因都是因为我使用 Docker 安装的 HA 没法使用蓝牙，所以我想着是不是容器版的 HA 是不是不支持蓝牙（脑子抽了）要不换成别的版本试试，也就有了这篇博客的记录。</p>
<p>首先看官方文档👀，根据 <a target="_blank" rel="noopener" href="https://github.com/home-assistant/architecture/blob/master/adr/0014-home-assistant-supervised.md">Home Assistant Supervised 官方安装指南</a>，只能安装在 Debian 12 Bookworm 上 (no derivatives 没错，就是连 Ubuntu 也不行)，虽然说 OrangePi 官方提供了 Debian 的系统镜像，但博主已经在 Ubuntu 上深耕多年，暂且不想脱离温柔乡，所以开始了网上寻找线索，试着突破这个限制。</p>
<p>一开始找到了一个在 Gist 上找了个一键安装脚本，结果由于其中有一行通过 curl 读取远程网络配置写入本地的<code>/etc/NetworkManager/NetworkManager.conf</code>，然后由于链接中的源文件丢失，写入了一行 <code>404: Not Found</code>，这还是后来才发现的；当时我一下就傻了，<code>NetworkManager.service</code> 怎么还出问题了，我首先就是重启该服务，试了几遍不管用，那这样我只好重启大法了，结果糟糕了，我直接连不上 ssh 了，怎么把这茬给忘了。</p>
<p>之后把香橙派接上显示器，在网上找了半天的排查方法，通过命令查询到对应的日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ journalctl -u NetworkManager -b</span><br></pre></td></tr></table></figure>

<p>才定位到是<code>/etc/NetworkManager/NetworkManager.conf</code>的问题，接着照着相关文档，删除设备网卡状态管理文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/NetworkManager/NetworkManager.state</span><br></pre></td></tr></table></figure>

<p>然后重启网络服务，网络状态会刷新并写入上述配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> service network-manager start</span><br></pre></td></tr></table></figure>

<p>后续算是找到个靠谱的安装方法[^1]，照着流程，先安装相关依赖包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt install \</span><br><span class="line">apparmor \</span><br><span class="line">jq \</span><br><span class="line">wget \</span><br><span class="line">curl \</span><br><span class="line">udisks2 \</span><br><span class="line">libglib2.0-bin \</span><br><span class="line">network-manager \</span><br><span class="line">dbus \</span><br><span class="line">lsb-release \</span><br><span class="line">systemd-journal-remote -y</span><br></pre></td></tr></table></figure>

<p>然后打开香橙派官方提供的系统配置工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rangepi-config</span><br></pre></td></tr></table></figure>

<p>在 System → Bootenv 中，追加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extraargs=apparmor=1 security=apparmor</span><br><span class="line">systemd.unified_cgroup_hierarchy=0</span><br></pre></td></tr></table></figure>

<p>分别是开启  AppArmor 和 CGroupV1 的支持，之后重启系统，生效配置。</p>
<blockquote>
<p>AppArmor (Application Armor)是 Linux 内核的一个安全模块，AppArmor 允许系统管理员将每个程序与一个安全配置文件关联，从而限制程序的功能。AppArmor 是与 SELinux 类似的一个访问控制系统，通过它你可以指定程序可以读、写或运行哪些文件，是否可以打开网络端口等。</p>
</blockquote>
<p>再是安装 Docker，就跳过了，开始安装 HA：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/home-assistant/os-agent/releases/download/1.6.0/os-agent_1.5.1_linux_aarch64.deb</span><br><span class="line">$ dpkg -i os-agent_1.6.0_linux_aarch64.deb</span><br></pre></td></tr></table></figure>

<p>这里出现了问题了，也就是开头提到的，报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[error] Ubuntu 20.04.5 LTS is not supported!</span><br></pre></td></tr></table></figure>

<p>这里绕过的方法有两种，一是原教程评论区中提到的修改<code>/etc/os-release</code>文件，对，就是手动修改系统定义的配置：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- PRETTY_NAME=&quot;Ubuntu 22.04.5 LTS&quot;</span></span><br><span class="line"><span class="addition">+ PRETTY_NAME=&quot;Debian GNU/Linux 12 (bookworm)&quot;</span></span><br></pre></td></tr></table></figure>

<p>另一种就是在 HA 官方论坛，有老六发现的方法[^2]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> BYPASS_OS_CHECK=<span class="literal">true</span> dpkg -i homeassistant-supervised.deb</span><br></pre></td></tr></table></figure>

<p>没错，通过逆向分析了 <code>homeassistant-supervised.deb</code> 找到了官方留下的后门。</p>
<p>之后就是一路绿灯，成功地进入到了 <code>http://localhost:8123</code>。</p>
<p>然后还是有问题，不过问题不大，初始化程序检测到 Docker 中部署了 unhealthy 的镜像，先删除就好了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error installing Home Assistant</span><br><span class="line">Found image in unhealthy image list &#x27;portainer/portainer-ce&#x27; on the host</span><br></pre></td></tr></table></figure>

<p>最后终于是进去了，不过蓝牙还是不能使用，这让我重新开始思考这个问题，是的，在使用 Docker 部署 HA 时，我已经挂载了蓝牙相关设备了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> docker run -d \</span><br><span class="line">	<span class="comment">#...</span></span><br><span class="line">    -v /dev:/dev \</span><br><span class="line">    -v /run/dbus:/run/dbus \</span><br><span class="line">    -v /var/run/dbus:/var/run/dbus \</span><br><span class="line">    homeassistant/home-assistant:2024.5</span><br></pre></td></tr></table></figure>

<p> 然后现在这确实跟安装的版本没多大关系，所以我将问题方向转移到蓝牙本身上来，先使用管理工具查看蓝牙设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rfkill list all</span><br><span class="line"></span><br><span class="line">0: tpacpi_bluetooth_sw: Bluetooth</span><br><span class="line">    Soft blocked: <span class="built_in">yes</span></span><br><span class="line">    Hard blocked: no</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>rfkill</code>命令来自英文词组 <em>radio frequency kill</em> 的缩写，其功能是管理系统中的蓝牙和 Wi-Fi 设备，是一个内核级别的管理工具。</p>
</blockquote>
<p>哇，蓝牙竟然没开，真相大白了（<strong>Soft blocked: yes</strong>：表示蓝牙设备当前被软件禁用，<strong>Hard blocked: no</strong>：表示蓝牙设备没有被硬件禁用，即物理开关处于开启状态，没有物理阻塞）。</p>
<p>接着自然是使用命令，解除软件阻塞：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rfkill unblock 0</span><br></pre></td></tr></table></figure>

<p>最后还是决定换回 Docker 安装的 HA，以下是卸载脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> apparmor</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> hassio-apparmor.service</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> hassio-supervisor.service</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl reset-failed</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> /etc/systemd/system/hassio-supervisor.service</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> /etc/systemd/system/hassio-apparmor.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># sudo docker kill $(sudo docker ps -q) &amp;&amp; sudo docker rm $(sudo docker ps -a -q) </span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /usr/share/hassio</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> /usr/sbin/hassio-apparmor</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> /usr/sbin/hassio-supervisor</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> /usr/bin/ha</span><br></pre></td></tr></table></figure>

<p>注释的命令是删除全部 Docker 的容器，如果是才装的 Docker 那就全一并删除了（博主就是觉得 Supervised 版太散了，安装了一堆容器，才放弃的，重回 Docker 版）。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>[^1]:<a target="_blank" rel="noopener" href="https://gist.github.com/renatoccosta/c30f0b4216c8caaf1f202b0a0561b5d3">Install Home Assistant on OrangePi 5 </a><br>[^2]: <a target="_blank" rel="noopener" href="https://community.home-assistant.io/t/install-on-unbuntu-20-04-5-or-22-04-1/524361/5">Install on Unbuntu 20.04.5 or 22.04.1</a></p>
</article><div id="paginator"></div></main><footer><div class="icon-wrapper in-left"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></button></div><div class="icon-wrapper in-right"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></span></button></div><p class="copyright-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer">CC BY-NC-SA 4.0</a><span>·</span><a href="https://github.com/ttttonyhe/ouorz-mono" target="_blank" rel="noreferrer">Open Source Software (OSS)</a></p></footer><script src="/js/ouo.js"></script></div></body></html>