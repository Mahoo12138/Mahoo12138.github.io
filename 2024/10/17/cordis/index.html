<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>写框架的框架—— Cordis 源码解析 （个人向） [ Mahoo12138 ]</title><link rel="stylesheet" href="/css/index.css"><meta name="post"><link rel="stylesheet" href="/css/layouts/post.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="hexo-container"><header></header><main id="content"><article id="post"><h1>写框架的框架—— Cordis 源码解析 （个人向）</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ol>
<li><p>拉取代码</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@github.com:cordiverse/cordis.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>拉取依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 仓库默认使用 yarn 作为包管理器，不折腾</span></span><br><span class="line">$ yarn</span><br></pre></td></tr></table></figure>
</li>
<li><p>预编译工作区子包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对应命令为 yarn yakumo build</span></span><br><span class="line">$ yarn build</span><br></pre></td></tr></table></figure></li>
</ol>
<p>项目结构：</p>
<ul>
<li><code>cordis</code>：Meta-Framework for Modern JavaScript Applications</li>
<li><code>@cordisjs/core</code>：↑</li>
<li><code>create-cordis</code>：Setup a Cordis application</li>
<li><code>@cordisjs/plugin-hmr</code>：Hot Module Replacement Plugin for Cordis、</li>
<li><code>@cordisjs/loader</code>：Loader for cordis</li>
<li><code>@cordisjs/logger</code>：Logger service for cordis</li>
<li><code>@cordisjs/schema</code>：Schema service for cordis</li>
<li><code>@cordisjs/timer</code>：Timer service for cordis</li>
</ul>
<p>主要依赖：</p>
<ul>
<li><code>c8</code>：output coverage reports using Node.js’ built in coverage.</li>
<li><code>esbuild</code>：An extremely fast bundler for the web.</li>
<li><code>esbuild-register</code>：Transpile JSX, TypeScript and esnext features on the fly with esbuild.</li>
<li><code>mocha</code>：simple, flexible, fun javascript test framework for node.js &amp; the browser.</li>
<li><code>shx</code>：Portable Shell Commands for Node.</li>
<li><code>tsx</code>：TypeScript Execute | The easiest way to run TypeScript in Node.js.</li>
<li><code>yakumo</code>：Manage complex workspaces with ease.</li>
<li><code>yml-register</code>：Hooks into Node’s require function to load <code>.yaml</code> and <code>.yml</code> files.</li>
</ul>
<hr>
<p>学习源码时，刚拿到一个全新的框架项目，不像常规的业务代码项目，往往抽象程序时是很高的，我的经验是，首先是略读一遍项目文档：<a target="_blank" rel="noopener" href="https://cordis.moe/zh-CN/guide/">介绍 | Cordis</a>，之后针对代码细节回顾文档内容。</p>
<p>当前 Cordis 文档尚未完善，不过已有的内容已经够我理解一段时间了。</p>
<p>扫一眼项目结构和依赖后，可以聚焦到项目的单元测试代码，能最快的了解到整个项目，各个模块单元的情况或者说作用责任。</p>
<p>注意到，在 <code>package.json</code> 确实存在多条用于测试的命令，其中：<code>yarn yakumo mocha --import tsx</code>，执行后发现，只打印了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">⚡Mahoo12138 ❯❯ yarn <span class="built_in">test</span></span><br><span class="line">unknown <span class="built_in">command</span>: mocha</span><br></pre></td></tr></table></figure>

<p>好像有什么不对劲的地方，保持好奇心，继续试验了其他几条：</p>
<ul>
<li><code>shx rm -rf coverage &amp;&amp; c8 -r text yarn test</code></li>
<li><code>...</code></li>
</ul>
<p>执行后都打印了 <code>unknown command: mocha</code>，但是也如期输出了测试覆盖率，代码逻辑是正常运行的。</p>
<p>接着我们直接对每个用例进行测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx mocha ./**/tests/*.spec.ts --require esbuild-register</span><br></pre></td></tr></table></figure>

<p>也都正常输出，那么项目的基本配置应该没问题，可以针对每个测试项进行分析和学习了。</p>
<h2 id="section-Association"><a href="#section-Association" class="headerlink" title="section: Association"></a>section: Association</h2><h3 id="case-service-injection"><a href="#case-service-injection" class="headerlink" title="case: service injection"></a>case: service injection</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\core\tests\associate.spec.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> root = <span class="keyword">new</span> <span class="title class_">Context</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Service</span> &#123;</span><br><span class="line">    qux = <span class="number">1</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(ctx, <span class="string">&#x27;foo&#x27;</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooBar</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Service</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(ctx, <span class="string">&#x27;foo.bar&#x27;</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root.<span class="title function_">plugin</span>(<span class="title class_">Foo</span>)</span><br><span class="line"><span class="keyword">const</span> fork = root.<span class="title function_">plugin</span>(<span class="title class_">FooBar</span>)</span><br><span class="line"><span class="title function_">expect</span>(root.<span class="property">foo</span>).<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">instanceof</span>(<span class="title class_">Foo</span>)</span><br><span class="line"><span class="title function_">expect</span>(root.<span class="property">foo</span>.<span class="property">bar</span>).<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">instanceof</span>(<span class="title class_">FooBar</span>)</span><br><span class="line"><span class="title function_">expect</span>(root.<span class="property">foo</span>.<span class="property">qux</span>).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="number">1</span>)</span><br><span class="line">fork.<span class="title function_">dispose</span>()</span><br><span class="line"><span class="title function_">expect</span>(root.<span class="property">foo</span>.<span class="property">bar</span>).<span class="property">to</span>.<span class="property">be</span>.<span class="property">undefined</span></span><br></pre></td></tr></table></figure>

<h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><p>首先创建了一个 Context 对象：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Context</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">config?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        config = <span class="title function_">resolveConfig</span>(<span class="variable language_">this</span>.<span class="property">constructor</span>, config)</span><br><span class="line">        <span class="variable language_">this</span>[symbols.<span class="property">store</span>] = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">        <span class="variable language_">this</span>[symbols.<span class="property">isolate</span>] = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">        <span class="variable language_">this</span>[symbols.<span class="property">internal</span>] = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">        <span class="variable language_">this</span>[symbols.<span class="property">intercept</span>] = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">self</span>: <span class="title class_">Context</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>, <span class="title class_">ReflectService</span>.<span class="property">handler</span>)</span><br><span class="line">        self.<span class="property">root</span> = self</span><br><span class="line">        self.<span class="property">reflect</span> = <span class="keyword">new</span> <span class="title class_">ReflectService</span>(self)</span><br><span class="line">        self.<span class="property">registry</span> = <span class="keyword">new</span> <span class="title class_">Registry</span>(self, config)</span><br><span class="line">        self.<span class="property">lifecycle</span> = <span class="keyword">new</span> <span class="title class_">Lifecycle</span>(self)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">attach</span> = (<span class="params"><span class="attr">internal</span>: <span class="title class_">Context</span>[<span class="keyword">typeof</span> symbols.internal]</span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!internal) <span class="keyword">return</span></span><br><span class="line">            <span class="title function_">attach</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(internal))</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(internal)) &#123;</span><br><span class="line">                <span class="keyword">const</span> constructor = internal[key][<span class="string">&#x27;prototype&#x27;</span>]?.<span class="property">constructor</span></span><br><span class="line">                <span class="keyword">if</span> (!constructor) <span class="keyword">continue</span></span><br><span class="line">                self[internal[key][<span class="string">&#x27;key&#x27;</span>]] = <span class="keyword">new</span> <span class="title function_">constructor</span>(<span class="params">self, config</span>)</span><br><span class="line">                <span class="title function_">defineProperty</span>(self[internal[key][<span class="string">&#x27;key&#x27;</span>]], <span class="string">&#x27;ctx&#x27;</span>, self)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">attach</span>(<span class="variable language_">this</span>[symbols.<span class="property">internal</span>])</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveConfig</span>(<span class="params"><span class="attr">plugin</span>: <span class="built_in">any</span>, <span class="attr">config</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> schema = plugin[<span class="string">&#x27;Config&#x27;</span>] || plugin[<span class="string">&#x27;schema&#x27;</span>]</span><br><span class="line">  <span class="keyword">if</span> (schema &amp;&amp; plugin[<span class="string">&#x27;schema&#x27;</span>] !== <span class="literal">false</span>) config = <span class="title function_">schema</span>(config)</span><br><span class="line">  <span class="keyword">return</span> config ?? &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> defineProperty&lt;T, K <span class="keyword">extends</span> keyof <span class="built_in">any</span>&gt;(<span class="attr">object</span>: T, <span class="attr">key</span>: K, <span class="attr">value</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">object</span>, key, &#123; <span class="attr">writable</span>: <span class="literal">true</span>, value, <span class="attr">enumerable</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接收一个可选的 <code>config</code> 配置参数，并调用了<code>resolveConfig</code>，且这里是把 Context 当作一个插件传入，解析其<code>Config</code>和<code>schema</code>，生成一个 <code>config</code>；</li>
<li>然后创建一些内部存储对象，如 <code>store</code>、<code>isolate</code>、<code>internal</code> 和 <code>intercept</code>，使用<code>Object.create(null)</code>，确保了对象的纯洁性，是没有原型链的。</li>
<li>接着，它创建一个 <code>Proxy</code> 对象，且传入 <code>this</code>，也就是拦截属性访问，交由 <code>ReflectService.handler</code>处理。</li>
<li>执行它初始化 <code>ReflectService</code>、<code>Registry</code> 和 <code>Lifecycle</code>，并将它们挂载到 <code>context</code> 实例上，这里其实就已经在执行 <code>ReflectService.handler</code> 中的 <code>set</code> 逻辑了 。</li>
<li>其中 <code>self.root = self</code> 这一行很重要，对于使用 <code>new</code> 创建出来的 <code>Context</code> 会有该属性标记，即 root Context；</li>
<li>最后，递归调用 <code>attach</code>函数，附加内部服务来完成上下文对象的初始化。</li>
</ul>
<p>可以看看 <code>ReflectService.handler</code> 内的逻辑：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectService</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="attr">handler</span>: <span class="title class_">ProxyHandler</span>&lt;<span class="title class_">Context</span>&gt; = &#123;</span><br><span class="line">        <span class="attr">set</span>: <span class="function">(<span class="params">target, prop, value, <span class="attr">ctx</span>: <span class="title class_">Context</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> prop !== <span class="string">&#x27;string&#x27;</span>) <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, prop, value, ctx)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> [name, internal] = <span class="title class_">ReflectService</span>.<span class="title function_">resolveInject</span>(target, prop)</span><br><span class="line">            <span class="keyword">if</span> (!internal) &#123;</span><br><span class="line">                <span class="comment">// TODO warning</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, name, value, ctx)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (internal.<span class="property">type</span> === <span class="string">&#x27;accessor&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!internal.<span class="property">set</span>) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">return</span> internal.<span class="property">set</span>.<span class="title function_">call</span>(ctx, value, ctx[symbols.<span class="property">receiver</span>])</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ctx.<span class="property">reflect</span>.<span class="title function_">set</span>(name, value)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">resolveInject</span>(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">name</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> internal = ctx[symbols.<span class="property">internal</span>][name]</span><br><span class="line">        <span class="keyword">while</span> (internal?.<span class="property">type</span> === <span class="string">&#x27;alias&#x27;</span>) &#123;</span><br><span class="line">            name = internal.<span class="property">name</span></span><br><span class="line">            internal = ctx[symbols.<span class="property">internal</span>][name]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [name, internal] <span class="keyword">as</span> <span class="keyword">const</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ReflectService.resolveInject</code> 用于获取<code>ctx[symbols.internal]</code>中传入的<code>name</code> 属性，针对<code>internal?.type === &#39;alias&#39;</code> 做了递进获取；</p>
<p><code>ReflectService.handler.set</code> 根据<code>props</code>和<code>internal</code>处理了属性赋值的多种情况，根据已有的代码信息还不好理解其作用。</p>
<h4 id="ReflectService"><a href="#ReflectService" class="headerlink" title="ReflectService"></a>ReflectService</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectService</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> <span class="attr">ctx</span>: <span class="title class_">Context</span></span>) &#123;</span><br><span class="line">        <span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, symbols.<span class="property">tracker</span>, &#123;</span><br><span class="line">            <span class="attr">associate</span>: <span class="string">&#x27;reflect&#x27;</span>,</span><br><span class="line">            <span class="attr">property</span>: <span class="string">&#x27;ctx&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_mixin</span>(</span><br><span class="line">            <span class="string">&#x27;reflect&#x27;</span>, [<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;provide&#x27;</span>, <span class="string">&#x27;accessor&#x27;</span>, <span class="string">&#x27;mixin&#x27;</span>, <span class="string">&#x27;alias&#x27;</span>])</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_mixin</span>(<span class="string">&#x27;scope&#x27;</span>, [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;runtime&#x27;</span>, <span class="string">&#x27;effect&#x27;</span>, <span class="string">&#x27;collect&#x27;</span>, <span class="string">&#x27;accept&#x27;</span>, <span class="string">&#x27;decline&#x27;</span>])</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_mixin</span>(<span class="string">&#x27;registry&#x27;</span>, [<span class="string">&#x27;using&#x27;</span>, <span class="string">&#x27;inject&#x27;</span>, <span class="string">&#x27;plugin&#x27;</span>])</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_mixin</span>(</span><br><span class="line">            <span class="string">&#x27;lifecycle&#x27;</span>, [<span class="string">&#x27;on&#x27;</span>, <span class="string">&#x27;once&#x27;</span>, <span class="string">&#x27;parallel&#x27;</span>, <span class="string">&#x27;emit&#x27;</span>, <span class="string">&#x27;serial&#x27;</span>, <span class="string">&#x27;bail&#x27;</span>, <span class="string">&#x27;start&#x27;</span>, <span class="string">&#x27;stop&#x27;</span>])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">_mixin</span>(<span class="params"><span class="attr">source</span>: <span class="built_in">any</span>, <span class="attr">mixins</span>: <span class="built_in">string</span>[] | <span class="title class_">Dict</span>&lt;<span class="built_in">string</span>&gt;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> entries = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(mixins) ? mixins.<span class="title function_">map</span>(<span class="function"><span class="params">key</span> =&gt;</span> [key, key]) : <span class="title class_">Object</span>.<span class="title function_">entries</span>(mixins)</span><br><span class="line">        <span class="keyword">const</span> getTarget = <span class="keyword">typeof</span> source === <span class="string">&#x27;string&#x27;</span> ? <span class="function">(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span></span>) =&gt;</span> ctx[source] : <span class="function">() =&gt;</span> source</span><br><span class="line">        <span class="keyword">const</span> disposables = entries.<span class="title function_">map</span>(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_accessor</span>(value, &#123;</span><br><span class="line">                <span class="title function_">get</span>(<span class="params">receiver</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> service = <span class="title function_">getTarget</span>(<span class="variable language_">this</span>)</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_">isNullable</span>(service)) <span class="keyword">return</span> service</span><br><span class="line">                    <span class="keyword">const</span> mixin = receiver ? <span class="title function_">withProps</span>(receiver, service) : service</span><br><span class="line">                    <span class="keyword">const</span> value = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(service, key, mixin)</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">&#x27;function&#x27;</span>) <span class="keyword">return</span> value</span><br><span class="line">                    <span class="keyword">return</span> value.<span class="title function_">bind</span>(mixin ?? service)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="title function_">set</span>(<span class="params">value, receiver</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> service = <span class="title function_">getTarget</span>(<span class="variable language_">this</span>)</span><br><span class="line">                    <span class="keyword">const</span> mixin = receiver ? <span class="title function_">withProps</span>(receiver, service) : service</span><br><span class="line">                    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(service, key, value, mixin)</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> disposables.<span class="title function_">forEach</span>(<span class="function"><span class="params">dispose</span> =&gt;</span> <span class="title function_">dispose</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">_accessor</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">options</span>: <span class="title class_">Omit</span>&lt;<span class="title class_">Context</span>.<span class="title class_">Internal</span>.<span class="title class_">Accessor</span>, <span class="string">&#x27;type&#x27;</span>&gt;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> internal = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">root</span>[symbols.<span class="property">internal</span>]</span><br><span class="line">        <span class="keyword">if</span> (name <span class="keyword">in</span> internal) <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">        internal[name] = &#123; <span class="attr">type</span>: <span class="string">&#x27;accessor&#x27;</span>, ...options &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="keyword">delete</span> internal[name]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">withProps</span>(<span class="params"><span class="attr">target</span>: <span class="built_in">any</span>, props?: &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!props) <span class="keyword">return</span> target</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">(<span class="params">target, prop, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (prop <span class="keyword">in</span> props &amp;&amp; prop !== <span class="string">&#x27;constructor&#x27;</span>) <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(props, prop, receiver)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, prop, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="function">(<span class="params">target, prop, value, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (prop <span class="keyword">in</span> props &amp;&amp; prop !== <span class="string">&#x27;constructor&#x27;</span>) <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(props, prop, value, receiver)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, prop, value, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数中，通过调用 <code>this._mixin</code> 方法，对 reflect，scope，registry，lifecycle 这几个对象中的多个方法调用了 <code>this._accessor</code> 方法：</p>
<ul>
<li>获取了<code>this.ctx.root[symbols.internal]</code>；</li>
<li>将<code>internal[name]</code>设置为 <code>type=accessor</code> 的<code>get/set</code>的对象；</li>
</ul>
<p>&#x2F;&#x2F; TODO get&#x2F;set</p>
<p>其中这里的 <code>get/set</code> 也就是 <code>ReflectService.handler</code>的 <code>get/set</code> 进行 <code>internal.set/get.call</code>调用时的函数。</p>
<h4 id="Registry"><a href="#Registry" class="headerlink" title="Registry"></a>Registry</h4><p><code>Context</code> 构造时，也初始化了一个 <code>Registry</code> 对象：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Registry</span>&lt;C <span class="keyword">extends</span> <span class="title class_">Context</span> = <span class="title class_">Context</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> _counter = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> _internal = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="title class_">Function</span>, <span class="title class_">MainScope</span>&lt;C&gt;&gt;()</span><br><span class="line">    <span class="keyword">protected</span> <span class="attr">context</span>: <span class="title class_">Context</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> <span class="attr">ctx</span>: C, <span class="attr">config</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        <span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, symbols.<span class="property">tracker</span>, &#123;</span><br><span class="line">            <span class="attr">associate</span>: <span class="string">&#x27;registry&#x27;</span>,</span><br><span class="line">            <span class="attr">property</span>: <span class="string">&#x27;ctx&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">context</span> = ctx</span><br><span class="line">        <span class="keyword">const</span> runtime = <span class="keyword">new</span> <span class="title class_">MainScope</span>(ctx, <span class="literal">null</span>!, config)</span><br><span class="line">        ctx.<span class="property">scope</span> = runtime</span><br><span class="line">        runtime.<span class="property">ctx</span> = ctx</span><br><span class="line">        runtime.<span class="property">status</span> = <span class="title class_">ScopeStatus</span>.<span class="property">ACTIVE</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">set</span>(<span class="literal">null</span>!, runtime)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">set</span>(<span class="params"><span class="attr">plugin</span>: <span class="title class_">Plugin</span>, <span class="attr">state</span>: <span class="title class_">MainScope</span>&lt;C&gt;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = <span class="variable language_">this</span>.<span class="title function_">resolve</span>(plugin)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_internal</span>.<span class="title function_">set</span>(key!, state)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="attr">plugin</span>: <span class="title class_">Plugin</span>, assert = <span class="literal">false</span>): <span class="title class_">Function</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">        <span class="comment">// Allow `null` as a special case.</span></span><br><span class="line">        <span class="keyword">if</span> (plugin === <span class="literal">null</span>) <span class="keyword">return</span> plugin</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建了一个 <code>MainScope</code> 对象赋值到 <code>ctx.scope</code>，初始化 <code>MainScope</code> 的状态，然后 <code>null</code>  这个特殊键及 <code>MainScope</code> 存入 <code>_internal</code> 中。</p>
<h4 id="MainScope"><a href="#MainScope" class="headerlink" title="MainScope"></a>MainScope</h4><p><code>Registry</code> 构造时，<code>plugin</code> 传入的是 <code>null</code>，</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MainScope</span>&lt;C <span class="keyword">extends</span> <span class="title class_">Context</span> = <span class="title class_">Context</span>&gt; <span class="keyword">extends</span> <span class="title class_">EffectScope</span>&lt;C&gt; &#123;</span><br><span class="line">    name?: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">ctx</span>: C, <span class="keyword">public</span> <span class="attr">plugin</span>: <span class="title class_">Plugin</span>, <span class="attr">config</span>: <span class="built_in">any</span>, error?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(ctx, config)</span><br><span class="line">        <span class="keyword">if</span> (!plugin) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">isActive</span> = <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setup</span>()</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">init</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MainScope</code> 继承自 <code>EffectScope</code>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">EffectScope</span>&lt;C <span class="keyword">extends</span> <span class="title class_">Context</span> = <span class="title class_">Context</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">uid</span>: <span class="built_in">number</span> | <span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="attr">ctx</span>: C</span><br><span class="line">    <span class="keyword">public</span> isActive = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="attr">proxy</span>: <span class="built_in">any</span></span><br><span class="line">    </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> <span class="attr">parent</span>: C, <span class="keyword">public</span> <span class="attr">config</span>: C[<span class="string">&#x27;config&#x27;</span>]</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uid</span> = parent.<span class="property">registry</span> ? parent.<span class="property">registry</span>.<span class="property">counter</span> : <span class="number">0</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span> = <span class="variable language_">this</span>.<span class="property">context</span> = parent.<span class="title function_">extend</span>(&#123; <span class="attr">scope</span>: <span class="variable language_">this</span> &#125;)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">            <span class="attr">get</span>: <span class="function">(<span class="params">target, key</span>) =&gt;</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(<span class="variable language_">this</span>.<span class="property">config</span>, key),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>parent.extend(&#123; scope: this &#125;)</code>调用后，执行的代码量非常多，整体看下来，是根据 <code>ctx[symbols.shadow]</code>和<code>[symbols.tracker]</code>返回 <code>context</code> 或基于其的一个 <code>Proxy</code> 对象，以及还有 <code>&#123; scope: this &#125;</code> 的 <code>MainScope</code> ，需要理解 <code>Traceable</code> 这个概念才能搞懂这里代码的作用。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Context</span> &#123;</span><br><span class="line">    <span class="title function_">extend</span>(meta = &#123;&#125;): <span class="variable language_">this</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> source = <span class="title class_">Reflect</span>.<span class="title function_">getOwnPropertyDescriptor</span>(<span class="variable language_">this</span>, symbols.<span class="property">shadow</span>)?.<span class="property">value</span></span><br><span class="line">        <span class="keyword">const</span> self = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title function_">getTraceable</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>)), meta)</span><br><span class="line">        <span class="keyword">if</span> (!source) <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(self), &#123; [symbols.<span class="property">shadow</span>]: source &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> getTraceable&lt;T&gt;(<span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">value</span>: T, noTrap?: <span class="built_in">boolean</span>): T &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value)) <span class="keyword">return</span> value</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">hasOwn</span>(value, symbols.<span class="property">shadow</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> tracker = value[symbols.<span class="property">tracker</span>]</span><br><span class="line">  <span class="keyword">if</span> (!tracker) <span class="keyword">return</span> value</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createTraceable</span>(ctx, value, tracker, noTrap)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际调试中发现，对于 root 级 Context ，<code>getTraceable</code> 倒数第二行返回了， <code>createTraceable</code> 并未调用到，也不考虑其逻辑。</p>
<h4 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Lifecycle</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">ctx</span>: <span class="title class_">Context</span></span>) &#123;</span><br><span class="line">    <span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, symbols.<span class="property">tracker</span>, &#123;</span><br><span class="line">      <span class="attr">associate</span>: <span class="string">&#x27;lifecycle&#x27;</span>,</span><br><span class="line">      <span class="attr">property</span>: <span class="string">&#x27;ctx&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">scope</span>.<span class="title function_">leak</span>(<span class="variable language_">this</span>.<span class="title function_">on</span>(<span class="string">&#x27;internal/listener&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> level <span class="keyword">of</span> [<span class="string">&#x27;info&#x27;</span>, <span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>]) &#123;</span><br><span class="line">      ctx.<span class="property">scope</span>.<span class="title function_">leak</span>(<span class="variable language_">this</span>.<span class="title function_">on</span>(<span class="string">`internal/<span class="subst">$&#123;level&#125;</span>`</span>, <span class="function">(<span class="params">format, ...param</span>) =&gt;</span> &#123;&#125;))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// non-reusable plugin forks are not responsive to isolated service changes</span></span><br><span class="line">    ctx.<span class="property">scope</span>.<span class="title function_">leak</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">on</span>(<span class="string">&#x27;internal/before-service&#x27;</span>, <span class="keyword">function</span> (<span class="params"><span class="attr">this</span>: <span class="title class_">Context</span>, name</span>) &#123;&#125;, &#123;</span><br><span class="line">        <span class="attr">global</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Lifecycle</code>  构造函数中调用了<code>this.on</code> 注册了多个事件监听，且也都将解除绑定的 <code>dispose</code> 函数传入了<code>ctx.scope.leak</code> 方法；</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">EffectScope</span>&lt;C <span class="keyword">extends</span> <span class="title class_">Context</span> = <span class="title class_">Context</span>&gt; &#123;</span><br><span class="line">    leak&lt;T&gt;(<span class="attr">disposable</span>: T) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">defineProperty</span>(disposable, <span class="title class_">Context</span>.<span class="property">static</span>, <span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">collect</span>(<span class="params"><span class="attr">label</span>: <span class="built_in">string</span>, <span class="attr">callback</span>: () =&gt; <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> dispose = <span class="title function_">defineProperty</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">remove</span>(<span class="variable language_">this</span>.<span class="property">disposables</span>, dispose)</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">callback</span>()</span><br><span class="line">        &#125;, <span class="string">&#x27;name&#x27;</span>, label)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">push</span>(dispose)</span><br><span class="line">        <span class="keyword">return</span> dispose</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>leak</code> 方法的逻辑很简单，就是在销毁函数 <code>dispose(able)</code> 上挂载 <code>MainScope</code> 。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Lifecycle</span> &#123;</span><br><span class="line">    <span class="title function_">on</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">listener</span>: (...args: <span class="built_in">any</span>) =&gt; <span class="built_in">any</span>, options?: <span class="built_in">boolean</span> | <span class="title class_">EventOptions</span></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> options !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">            options = &#123; <span class="attr">prepend</span>: options &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// handle special events</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">scope</span>.<span class="title function_">assertActive</span>()</span><br><span class="line">        listener = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">reflect</span>.<span class="title function_">bind</span>(listener)</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">bail</span>(<span class="variable language_">this</span>.<span class="property">ctx</span>, <span class="string">&#x27;internal/listener&#x27;</span>, name, listener, options)</span><br><span class="line">        <span class="keyword">if</span> (result) <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> hooks = <span class="variable language_">this</span>.<span class="property">_hooks</span>[name] ||= []</span><br><span class="line">        <span class="keyword">const</span> label = <span class="keyword">typeof</span> name === <span class="string">&#x27;string&#x27;</span> ? <span class="string">`event &lt;<span class="subst">$&#123;name&#125;</span>&gt;`</span> : <span class="string">&#x27;event (Symbol)&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">register</span>(label, hooks, listener, options)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">bail</span>(<span class="params">...<span class="attr">args</span>: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> result <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;bail&#x27;</span>, args)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isBailed</span>(result)) <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    * <span class="title function_">dispatch</span>(<span class="params"><span class="attr">type</span>: <span class="built_in">string</span>, <span class="attr">args</span>: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> thisArg = <span class="keyword">typeof</span> args[<span class="number">0</span>] === <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> args[<span class="number">0</span>] === <span class="string">&#x27;function&#x27;</span> </span><br><span class="line">        ? args.<span class="title function_">shift</span>() : <span class="literal">null</span></span><br><span class="line">        <span class="keyword">const</span> name = args.<span class="title function_">shift</span>()</span><br><span class="line">        <span class="keyword">if</span> (name !== <span class="string">&#x27;internal/event&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;internal/event&#x27;</span>, <span class="keyword">type</span>, name, args, thisArg)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> hook <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="title function_">filterHooks</span>(<span class="variable language_">this</span>.<span class="property">_hooks</span>[name] || [], thisArg)) &#123;</span><br><span class="line">            <span class="keyword">yield</span> hook.<span class="property">callback</span>.<span class="title function_">apply</span>(thisArg, args)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">emit</span>(<span class="params">...<span class="attr">args</span>: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">        <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;emit&#x27;</span>, args))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">filterHooks</span>(<span class="params"><span class="attr">hooks</span>: <span class="title class_">Hook</span>[], thisArg?: <span class="built_in">object</span></span>) &#123;</span><br><span class="line">        thisArg = <span class="title function_">getTraceable</span>(<span class="variable language_">this</span>.<span class="property">ctx</span>, thisArg)</span><br><span class="line">        <span class="keyword">return</span> hooks.<span class="title function_">slice</span>().<span class="title function_">filter</span>(<span class="function">(<span class="params">hook</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> filter = thisArg?.[<span class="title class_">Context</span>.<span class="property">filter</span>]</span><br><span class="line">            <span class="keyword">return</span> hook.<span class="property">global</span> || !filter || filter.<span class="title function_">call</span>(thisArg, hook.<span class="property">ctx</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">register</span>(<span class="params"><span class="attr">label</span>: <span class="built_in">string</span>, <span class="attr">hooks</span>: <span class="title class_">Hook</span>[], <span class="attr">callback</span>: <span class="built_in">any</span>, <span class="attr">options</span>: <span class="title class_">EventOptions</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> method = options.<span class="property">prepend</span> ? <span class="string">&#x27;unshift&#x27;</span> : <span class="string">&#x27;push&#x27;</span></span><br><span class="line">        hooks[method](&#123; <span class="attr">ctx</span>: <span class="variable language_">this</span>.<span class="property">ctx</span>, callback, ...options &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">scope</span>.<span class="title function_">collect</span>(label, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">unregister</span>(hooks, callback))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看看 <code>Lifecycle.on</code> 方法：</p>
<ul>
<li><p>对传入的 <code>listener</code> 调用 <code>ReflectService.bind</code> ，跟 <code>getTraceable</code> 有关；</p>
</li>
<li><p>接着调用 <code>bail</code> 方法，前两个参数是固定的 <code>this.ctx</code> 和 <code>&#39;internal/listener&#39;</code></p>
<ul>
<li>其内部再调用了 <code>dispatch</code> 生成器函数，使用 <code>isBailed</code> 判断真值则返回；</li>
<li>生成器内部，获取首个对象类型的参数作为 <code>thisArg</code>，存在则将第二个参数作为 <code>name</code>；</li>
<li>其次，所有 <code>name</code> 不为 <code>internal/event</code> 的调用，都会调用<code>emit</code>方法，且事件名为 <code>&#39;internal/event&#39;</code>，递归调用 <code>dispatch</code>；</li>
<li>最后，通过<code>filterHooks</code> 方法筛选一遍 <code>this._hooks[&#39;internal/listener&#39;]</code>，返回 <code>hook.callback</code> 执行结果；</li>
</ul>
</li>
<li><p>若 <code>bail</code> 结果有值，则返回；否则直接获取 <code>_hooks[name]</code>，调用 <code>register</code> 方法；</p>
</li>
<li><p><code>register</code> 方法内，则将 <code>listener</code> 放入对应的 <code>hooks</code> 数组中，并通过 <code>EffectScope</code> 收集了 <code>unregister</code>方法；</p>
<ul>
<li><code>collect</code> 方法的实现，我觉得很巧妙，又很自然；</li>
<li>定义了一个 <code>dispose</code> 函数，函数体则是将从数组 <code>disposables</code> 中移除，并返回<code>unregister</code>回调执行结果；</li>
<li>然后将 <code>dispose</code> push 到 <code>disposables</code> 数组中，返回 <code>dispose</code> 函数，即为 <code>leak</code> 的参数；</li>
</ul>
</li>
</ul>
<p>整体上来看，<code>on</code> 方法执行时，会调用 <code>bail</code> 做一个前置操作，包括：</p>
<ul>
<li>触发 <code>internal/event</code> 事件，以及 <code>internal/listener</code> 事件；</li>
<li>如果有返回值，那就终止 <code>on</code> 后续事件注册的 <code>register</code> 方法执行；</li>
</ul>
<p>&#x2F;&#x2F; TODO trace bind</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectService</span> &#123;</span><br><span class="line">    trace&lt;T&gt;(<span class="attr">value</span>: T) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getTraceable</span>(<span class="variable language_">this</span>.<span class="property">ctx</span>, value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bind&lt;T <span class="keyword">extends</span> <span class="title class_">Function</span>&gt;(<span class="attr">callback</span>: T) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(callback, &#123;</span><br><span class="line">            <span class="attr">apply</span>: <span class="function">(<span class="params">target, thisArg, args</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> target.<span class="title function_">apply</span>(</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">trace</span>(thisArg), </span><br><span class="line">                    args.<span class="title function_">map</span>(<span class="function"><span class="params">arg</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">trace</span>(arg))</span><br><span class="line">                )</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div id="paginator"></div></main><footer><div class="icon-wrapper in-left"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></button></div><div class="icon-wrapper in-right"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></span></button></div><p class="copyright-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer">CC BY-NC-SA 4.0</a><span>·</span><a href="https://github.com/ttttonyhe/ouorz-mono" target="_blank" rel="noreferrer">Open Source Software (OSS)</a></p></footer><script src="/js/ouo.js"></script></div></body></html>