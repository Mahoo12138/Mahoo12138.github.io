<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Flutter 开发之动态更新Dialog中的状态 [ Mahoo12138 ]</title><link rel="stylesheet" href="/css/index.css"><meta name="post"><link rel="stylesheet" href="/css/layouts/post.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="hexo-container"><header></header><main id="content"><article id="post"><h1>Flutter 开发之动态更新Dialog中的状态</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>之前在写一个登录页面的 demo 时，点击登录按钮，发送网络请求，并且弹出包含进度条的 Dialog，异步进行的网络请求得到结果后，根据请求结果动态更新 Dialog 的状态</p>
<p>一般的想法就是，使用 <strong>setState</strong> 状态，但实际情况下，Dialog 的状态并不会得到更新，于是开始查看<strong>Dialog</strong> 和 <strong>showDialog</strong> 的源码，在<strong>showDialog</strong>的源码中发现了一些端倪：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;T?&gt; showDialog&lt;T&gt;(&#123;</span><br><span class="line">  <span class="keyword">required</span> BuildContext context,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> Navigator.of(context, rootNavigator: useRootNavigator).push&lt;T&gt;(DialogRoute&lt;T&gt;(</span><br><span class="line">    context: context,</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在调用了 <code>showDialog</code> 方法后，实际上是进行了<strong>路由跳转</strong>的，这是对比安卓原生的一个很大区别，所以用 <code>Navigator.pop</code>关闭 Dialog；所以当收到请求结果后，进行的 setState 其实更新的是上一个路由界面的状态，也就不会对 Dialog 的状态进行更新。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>同样的，在<code>dialog.dart</code>源码 **showDialog **方法的注释部分也获悉到了正统的解决方法：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">This function takes a <span class="code">`builder`</span> which typically builds a [Dialog] widget.</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">Content below the dialog is dimmed with a [ModalBarrier]. The widget</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">returned by the <span class="code">`builder`</span> does not share a context with the location that</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">`showDialog`</span> is originally called from. Use a [StatefulBuilder] or a</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">custom [StatefulWidget] if the dialog needs to update dynamically.</span></span></span><br></pre></td></tr></table></figure>

<p>核心部分的简单翻译就是，**showDialog **的 builder 返回的 widget 没有共享 **showDialog **原来被调用的位置的 context，可以用 <code>StatefulBuilder</code> 或自定义 一个<code>StatefulWidget</code>来自动更新 Dialog。</p>
<p><strong>StatefulBuilder</strong> 的 builder 参数是一个<code>StatefulWidgetBuilder</code> 类型的函数，第一个参数是 context，第二个参数是 setState 函数，也就可以通过这个函数来刷新 Dialog。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> StatefulWidgetBuilder = Widget <span class="built_in">Function</span>(BuildContext context, StateSetter setState);</span><br></pre></td></tr></table></figure>

<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><p>我们可以简单模拟一个网络请求操作，来验证该方法是否可行。</p>
<p>构建一个基本的主页面，一个按钮，点击后发起网络操作，显示 Dialog，其<code>_buildLoginDialog()</code> 函数根据标志 <strong>flag</strong>  返回对应的内容：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">Scaffold(</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: [</span><br><span class="line">            TextButton(</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                showDialog(</span><br><span class="line">                    context: context,</span><br><span class="line">                    builder: (context) &#123;</span><br><span class="line">                      <span class="keyword">return</span> StatefulBuilder(builder: (context, state)&#123;</span><br><span class="line">                        <span class="keyword">if</span> (mounted &amp;&amp; flag == <span class="number">0</span> )&#123;</span><br><span class="line">                          _login(state);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> Dialog(</span><br><span class="line">                          child: _buildLoginDialog(),</span><br><span class="line">                        );</span><br><span class="line"></span><br><span class="line">                      &#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Text(<span class="string">&quot;测试&quot;</span>),</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>以下是<code>_buildLoginDialog() </code>代码实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">_buildLoginDialog() &#123;</span><br><span class="line">  <span class="keyword">if</span> (flag != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> Container(</span><br><span class="line">        height: <span class="number">200</span>,</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: [Text(<span class="string">&quot;用户名或密码错误&quot;</span>)],</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Container(</span><br><span class="line">        height: <span class="number">200</span>,</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: [</span><br><span class="line">            Container(</span><br><span class="line">              width: <span class="number">50</span>,</span><br><span class="line">              height: <span class="number">50</span>,</span><br><span class="line">              child: CircularProgressIndicator(),</span><br><span class="line">            ),</span><br><span class="line">            Padding(</span><br><span class="line">              padding: EdgeInsets.all(<span class="number">13</span>),</span><br><span class="line">              child: Text(<span class="string">&quot;登录成功！&quot;</span>),</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      height: <span class="number">200</span>,</span><br><span class="line">      child: Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: [</span><br><span class="line">          Container(</span><br><span class="line">            width: <span class="number">50</span>,</span><br><span class="line">            height: <span class="number">50</span>,</span><br><span class="line">            child: CircularProgressIndicator(),</span><br><span class="line">          ),</span><br><span class="line">          Padding(</span><br><span class="line">            padding: EdgeInsets.all(<span class="number">13</span>),</span><br><span class="line">            child: Text(<span class="string">&quot;登陆中&quot;</span>),</span><br><span class="line">          )</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要将 <strong>state</strong> 函数传入网络请求函数，进行页面状态更新：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_login(state) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;请求数据前：&quot;</span> + flag.toString());</span><br><span class="line">  <span class="keyword">await</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">3</span>), () &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;延时三秒后请求数据&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  state(() &#123;</span><br><span class="line">    flag = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请求数据后：&quot;</span> + flag.toString());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div id="paginator"></div></main><footer><div class="icon-wrapper in-left"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></button></div><div class="icon-wrapper in-right"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></span></button></div><p class="copyright-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer">CC BY-NC-SA 4.0</a><span>·</span><a href="https://github.com/ttttonyhe/ouorz-mono" target="_blank" rel="noreferrer">Open Source Software (OSS)</a></p></footer><script src="/js/ouo.js"></script></div></body></html>