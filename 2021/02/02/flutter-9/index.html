<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Flutter 学习实践之Banner轮播图 [ Mahoo12138 ]</title><link rel="stylesheet" href="/css/index.css"><meta name="post"><link rel="stylesheet" href="/css/layouts/post.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="hexo-container"><header></header><main id="content"><article id="post"><h1>Flutter 学习实践之Banner轮播图</h1><h2 id="PageView"><a href="#PageView" class="headerlink" title="PageView"></a>PageView</h2><p>PageView控件可以实现一个“图片轮播”的效果，PageView不仅可以水平滑动也可以垂直滑动。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PageView(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    this.scrollDirection = Axis.horizontal,</span><br><span class="line">    this.reverse = false,</span><br><span class="line">    PageController controller,</span><br><span class="line">    this.physics,</span><br><span class="line">    this.pageSnapping = true,</span><br><span class="line">    this.onPageChanged,</span><br><span class="line">    List&lt;Widget&gt; children = const &lt;Widget&gt;[],</span><br><span class="line">    this.dragStartBehavior = DragStartBehavior.start,</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>scrollDirection </code>，滚动方向；</p>
</li>
<li><p><code>reverse</code>，子视图倒置展示；</p>
</li>
<li><p><code>pageSnapping </code>，默认为 true，让 pageView 具有分页效果，滚到超到View页面一半，就会滚动到下一页，小于则停留在当前页；设置为 false，则滚到哪里算哪里，没有分页效果。</p>
</li>
<li><p><code>onPageChanged</code>，滚动会在回调中得到当前的索引值，默认从 0 开始，0，1，2…</p>
</li>
<li><p><code>PageController</code>，是描述 pageView 子视图的 widget：</p>
  <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PageController(&#123;</span><br><span class="line">    this.initialPage = 0,</span><br><span class="line">    this.keepPage = true,</span><br><span class="line">    this.viewportFraction = 1.0,</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>initialPage</code>，表示当前加载第几页，默认显示第一个视图，可自定义设置索引值；</p>
</li>
<li><p><code>keepPage</code>，是否保持已经渲染过的页面；</p>
</li>
<li><p><code>viewportFraction</code>，视图默认 100% 撑开显示，0 - 1，如果当前滚动方向为水平方向，会以宽度的%比，来缩放视图；如果当前滚动方向为垂直方向，会以高度的%比，来缩放视图</p>
</li>
</ul>
<p>简单使用如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="built_in">List</span> descriptions = [</span><br><span class="line">    <span class="string">&#x27;banner 0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;banner 1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;banner 2&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">Container(</span><br><span class="line">    height: <span class="number">200</span>,</span><br><span class="line">    child: PageView(</span><br><span class="line">        children: [</span><br><span class="line">            Card(</span><br><span class="line">                color: Colors.cyanAccent,</span><br><span class="line">                child: buildItemPage(<span class="number">0</span>),</span><br><span class="line">            ),</span><br><span class="line">            Card(</span><br><span class="line">                color: Colors.red,</span><br><span class="line">                child: buildItemPage(<span class="number">1</span>),</span><br><span class="line">            ),</span><br><span class="line">            Card(</span><br><span class="line">                color: Colors.yellow,</span><br><span class="line">                child: buildItemPage(<span class="number">2</span>),</span><br><span class="line">            )</span><br><span class="line">        ],</span><br><span class="line">    ),</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Widget buildItemPage(<span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        child: Text(descriptions[index]),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PageView-builder"><a href="#PageView-builder" class="headerlink" title="PageView.builder"></a>PageView.builder</h2><p>按需加载内容和视图数量：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PageView.builder(</span><br><span class="line">	itemBuilder: _pageItemBuilder,</span><br><span class="line">	itemCount: posts.length,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>一般巧用取模来实现<strong>无限滚动</strong>的效果：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="built_in">List</span> descriptions = [</span><br><span class="line">    <span class="string">&#x27;banner 0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;banner 1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;banner 2&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">Container(</span><br><span class="line">    height: <span class="number">200</span>,</span><br><span class="line">    child: PageView.builder(</span><br><span class="line">        controller: PageController(</span><br><span class="line">            viewportFraction: <span class="number">0.9</span></span><br><span class="line">        ),</span><br><span class="line">        itemBuilder: (context,index)&#123;</span><br><span class="line">            <span class="keyword">return</span> buildItemPage(index % descriptions.length);</span><br><span class="line">        &#125;,</span><br><span class="line">        itemCount: <span class="number">10000</span>,</span><br><span class="line">    ),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">Widget buildItemPage(<span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">return</span> Card(</span><br><span class="line">        color: Colors.lightBlue,</span><br><span class="line">        child: Container(</span><br><span class="line">            alignment: Alignment.center,</span><br><span class="line">            child: Text(descriptions[index]),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现指示器"><a href="#实现指示器" class="headerlink" title="实现指示器"></a>实现指示器</h2><p>常见的 Banner 轮播图都会有页面的指示器，一般显示总数和当前位置，可以通过<code>onPageChanged</code>回调确定当前页数并更新指示器。</p>
<p><img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/20210203093305.png"></p>
<h3 id="原点型"><a href="#原点型" class="headerlink" title="原点型"></a>原点型</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Stack(</span><br><span class="line">    children: [</span><br><span class="line">        PageView.builder(</span><br><span class="line">            controller: PageController(viewportFraction: <span class="number">0.9</span>),</span><br><span class="line">            itemBuilder: (context, index) &#123;</span><br><span class="line">                <span class="keyword">return</span> buildItemPage(index % descriptions.length);</span><br><span class="line">            &#125;,</span><br><span class="line">            itemCount: <span class="number">10000</span>,</span><br><span class="line">            onPageChanged: (index)&#123;</span><br><span class="line">                setState(() &#123;</span><br><span class="line">                    _currentDotIndex = index % descriptions.length;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        Positioned(</span><br><span class="line">            left: <span class="number">0</span>,</span><br><span class="line">            right: <span class="number">0</span>,</span><br><span class="line">            bottom: <span class="number">20</span>,</span><br><span class="line">            child: Row(</span><br><span class="line">                mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                children: <span class="built_in">List</span>.generate(</span><br><span class="line">                    descriptions.length,</span><br><span class="line">                    (index) =&gt; Container(</span><br><span class="line">                        margin: EdgeInsets.symmetric(horizontal: <span class="number">5</span>),</span><br><span class="line">                        width: <span class="number">10</span>,</span><br><span class="line">                        height: <span class="number">10</span>,</span><br><span class="line">                        decoration: BoxDecoration(</span><br><span class="line">                            shape: BoxShape.circle,</span><br><span class="line">                            color: (_currentDotIndex == index)</span><br><span class="line">                            ? Colors.deepPurpleAccent</span><br><span class="line">                            : Colors.white),</span><br><span class="line">                    )),</span><br><span class="line">            ))</span><br><span class="line">    ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="数字型"><a href="#数字型" class="headerlink" title="数字型"></a>数字型</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Stack(</span><br><span class="line">    children: [</span><br><span class="line">        PageView.builder(</span><br><span class="line">            controller: PageController(viewportFraction: <span class="number">0.9</span>),</span><br><span class="line">            itemBuilder: (context, index) &#123;</span><br><span class="line">                <span class="keyword">return</span> buildItemPage(index % descriptions.length);</span><br><span class="line">            &#125;,</span><br><span class="line">            itemCount: <span class="number">10000</span>,</span><br><span class="line">            onPageChanged: (index)&#123;</span><br><span class="line">                setState(() &#123;</span><br><span class="line">                    _currentNumIndex = index % descriptions.length;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        Positioned(</span><br><span class="line">            right: <span class="number">45</span>,</span><br><span class="line">            bottom: <span class="number">20</span>,</span><br><span class="line">            child: Container(</span><br><span class="line">                alignment: Alignment.center,</span><br><span class="line">                width: <span class="number">50</span>,</span><br><span class="line">                height: <span class="number">24</span>,</span><br><span class="line">                decoration: BoxDecoration(</span><br><span class="line">                    color: Colors.grey[<span class="number">200</span>].withOpacity(<span class="number">0.5</span>),</span><br><span class="line">                    borderRadius: BorderRadius.all(Radius.circular(<span class="number">12</span>))</span><br><span class="line">                ),</span><br><span class="line">                child: Text(<span class="string">&#x27;<span class="subst">$&#123;_currentNumIndex + <span class="number">1</span>&#125;</span>/<span class="subst">$&#123;descriptions.length&#125;</span>&#x27;</span>,style: TextStyle(fontSize: <span class="number">12</span>,),textAlign: TextAlign.center,),</span><br><span class="line">            ))</span><br><span class="line">    ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="自动轮播"><a href="#自动轮播" class="headerlink" title="自动轮播"></a>自动轮播</h2><p>常见的轮播图往往都有自动轮播这一需求，在 Flutter 中可以使用 Timer 定时器来实现。在组件的 <code>dispose()</code> 方法需要检查定时器，然后取消定时器，防止内存泄漏。通过 PageController 在每一次定时回调中调用其 <code>nextPage() </code>方法，切换下一页，值得注意的是，不同的 PageView 不能使用同一个 PageController 控制器。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PageController _pageController;</span><br><span class="line">Timer _timer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> initState() &#123;</span><br><span class="line">    _pageController = PageController(viewportFraction: <span class="number">0.9</span>);</span><br><span class="line">    _timer = Timer.periodic(<span class="built_in">Duration</span>(seconds: <span class="number">3</span>), (timer) &#123;</span><br><span class="line">        _pageController.nextPage(</span><br><span class="line">            duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">400</span>), curve: Curves.linear);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_timer.isActive) &#123;</span><br><span class="line">        _timer.cancel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PageView.builder(</span><br><span class="line">    controller: _pageController,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="优化轮播"><a href="#优化轮播" class="headerlink" title="优化轮播"></a>优化轮播</h3><p>当实现好自动轮播后，在实际交互中是非常不理想的，轮播会一直持续，不会响应点击触摸等手势，需要进一步优化：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GestureDetector(</span><br><span class="line">    child: buildItemPage(index % descriptions.length),</span><br><span class="line">    onTap: () &#123;</span><br><span class="line">        startBannerLoop();</span><br><span class="line">    &#125;,</span><br><span class="line">    onTapDown: (detail) &#123;</span><br><span class="line">        stopBannerLoop();</span><br><span class="line">    &#125;,</span><br><span class="line">    onTapCancel: () &#123;</span><br><span class="line">        startBannerLoop();</span><br><span class="line">    &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> stopBannerLoop() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_timer.isActive) &#123;</span><br><span class="line">        _timer.cancel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> startBannerLoop() &#123;</span><br><span class="line">    _timer = Timer.periodic(<span class="built_in">Duration</span>(seconds: <span class="number">3</span>), (timer) &#123;</span><br><span class="line">        _pageController.nextPage(</span><br><span class="line">            duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">400</span>), curve: Curves.linear);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div id="paginator"></div></main><footer><div class="icon-wrapper in-left"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></button></div><div class="icon-wrapper in-right"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></span></button></div><p class="copyright-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer">CC BY-NC-SA 4.0</a><span>·</span><a href="https://github.com/ttttonyhe/ouorz-mono" target="_blank" rel="noreferrer">Open Source Software (OSS)</a></p></footer><script src="/js/ouo.js"></script></div></body></html>