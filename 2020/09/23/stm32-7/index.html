<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>超乎你想象的Stm32中的 TIM 定时器（提高篇） [ Mahoo12138 ]</title><link rel="stylesheet" href="/css/index.css"><meta name="post"><link rel="stylesheet" href="/css/layouts/post.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="hexo-container"><header></header><main id="content"><article id="post"><h1>超乎你想象的Stm32中的 TIM 定时器（提高篇）</h1><p>注：本文属博主学习时所作笔记，内容源大参考于野火的《零死角玩转STM32F103》以及部分网络资料，笔记内容仅作为自己参考，免去频繁查询参考手册的麻烦，如有错误，还请指出！</p>
<p>高级定时器(STM32F1 系列中为 TIM1 和 TIM8)和通用定时器在基本定时器的基础上引入了<strong>外部引脚</strong>，可以实现输入捕获和输出比较功能。高级定时器比通用定时器增加了<strong>可编程死区互补输出、重复计数器、带刹车(断路)功能</strong>，这些功能都是针对电机控制方面。</p>
<img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/image-20200924221406588.png" alt="高级控制定时器框图" style="zoom:90%;" />

<p>由于TIM高级定时器结构复杂，功能众多，可以直接看野火的开发书籍，不做过多详述，文章主要侧重几个常用实验，并在代码中层层递进。</p>
<h2 id="PWM-信号输出控制-SG90-舵机"><a href="#PWM-信号输出控制-SG90-舵机" class="headerlink" title="PWM 信号输出控制 SG90 舵机"></a>PWM 信号输出控制 SG90 舵机</h2><p>该例程将通过将使用 STM32 输出 PWM 信号，控制 SG90 舵机进行转动，使用的是 TIM3 的通道1 为 PA6 口，舵机接线如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/image-20200925162930796.png" alt="SG90 舵机实物图"></p>
<h3 id="控制原理及-PWM-配置"><a href="#控制原理及-PWM-配置" class="headerlink" title="控制原理及 PWM 配置"></a>控制原理及 PWM 配置</h3><p><strong>伺服电机</strong>通常被称为<strong>舵机</strong>，它是一种带有输出轴的小装置。当我们向伺服器发送一个控制信号时，输出轴就可以转到特定的位置。只要控制信号持续不变，伺服机构就会保持轴的角度位置不改变。如果控制信号发生变化，输出轴的位置也会相应发生变化。</p>
<p>舵机的内部结构如上图所示。你可以看到<em>控制电路，马达，一组齿轮和外壳</em>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/servo_structure.png" alt="舵机的内部结构"></p>
<blockquote>
<p>舵机内部的控制电路，电位计（可变电阻器）和电机均被连接到电路板上，如内部结构图的右边部分。控制电路通过电位计可监控舵机的当前角度。</p>
<p>如果轴的位置与控制信号相符，那么电机就会关闭。如果控制电路发现这个角度不正确，它就会控制马达转动，直到它达到指定的角度。舵机角度根据制造商的不同而有所不同。比如，一个180度的舵机，它可以在0度至180度之间运动。由于限位装置被安装在主输出装置上，超出这个范围机械结构就不能再转动了。</p>
<p>舵机的输出功率与它所需要转动的距离成正比。如果输出轴需要转动很长的距离，马达就会全速运转，如果它只需要短距离转动，马达就会以较慢的速度运行，这叫做速度比例控制。</p>
</blockquote>
<p>舵机的控制一般需要一个 20ms 的时基脉冲，该脉冲的高电平部分一般为 0.5ms~2.5ms 范围内的角度控制脉冲部分。</p>
<p><img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/servo_motion.gif" alt="舵机的运动原理"></p>
<p>控制线用于传输角度控制信号。这个角度是由控制信号脉冲的持续时间决定的，这叫做<strong>脉冲编码调制（PCM）</strong>。舵机的控制一般需要一个20ms左右的时基脉冲，该脉冲的高电平部分一般为 0.5ms-2.5ms 范围，总间隔为 2ms。脉冲的宽度将决定马达转动的距离。例如：1.5毫秒的脉冲，电机将转向90度的位置（通常称为中立位置，对于180°舵机来说，就是90°位置）。如果脉冲宽度小于1.5毫秒，那么电机轴向朝向0度方向。如果脉冲宽度大于1.5毫秒，轴向就朝向180度方向。</p>
<p><img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/SERVO.gif" alt="伺服电机时序图"></p>
<p>综上，设置PWM周期为20ms &#x3D; (7200*200)&#x2F;72000000&#x3D;0.02，所以TIM_Period &#x3D; 199，TIM_Prescaler &#x3D; 7199。</p>
<p>以180度舵机 SG90 为例，对应的控制关系是这样的：</p>
<table>
<thead>
<tr>
<th>脉冲宽度</th>
<th>转动角度</th>
<th>设置占空比</th>
</tr>
</thead>
<tbody><tr>
<td>0.5 ms</td>
<td>0°</td>
<td>175</td>
</tr>
<tr>
<td>1.0 ms</td>
<td>45°</td>
<td>180</td>
</tr>
<tr>
<td>1.5 ms</td>
<td>90°</td>
<td>185</td>
</tr>
<tr>
<td>2.0 ms</td>
<td>135°</td>
<td>190</td>
</tr>
<tr>
<td>2.5 ms</td>
<td>180°</td>
<td>195</td>
</tr>
</tbody></table>
<h2 id="STM32工程目录"><a href="#STM32工程目录" class="headerlink" title="STM32工程目录"></a>STM32工程目录</h2><p>很久不接触 STM32 工程，文件结构差点乱了，这里贴个目录树：</p>
<blockquote>
<p>├─Doc<br>│      readme.txt<br>│<br>├─Libraries<br>│  ├─CMSIS<br>│  │  └─startup<br>│  │<br>│  └─FWlib<br>│      ├─inc<br>│      └─src<br>│<br>├─Listing<br>│<br>├─Output<br>│<br>├─Project<br>│  └─RVMDK（uv5）<br>│      └─DebugConfig<br>│<br>└─User<br>    │  main.c<br>    │  stm32f10x_conf.h<br>    │  stm32f10x_it.c<br>    │  stm32f10x_it.h<br>    │<br>    ├─PWM<br>    │      bsp_pwm.c<br>    │      bsp_pwm.h<br>    │<br>    └─SysTick<br>            bsp_SysTick.c<br>            bsp_SysTick.h</p>
</blockquote>
<h2 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h2><h4 id="bsp-pwm-h"><a href="#bsp-pwm-h" class="headerlink" title="bsp_pwm.h"></a>bsp_pwm.h</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span>  _BSP_PWM_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  _BSP_PWM_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="comment">// 这里使用 TIM3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM                   TIM3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM_APBxClock_FUN     RCC_APB1PeriphClockCmd</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM_CLK               RCC_APB1Periph_TIM3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM_Period            199</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM_Prescaler         7199</span></span><br><span class="line"><span class="comment">// TIM3 输出比较通道</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM_CH1_GPIO_CLK      RCC_APB2Periph_GPIOA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM_CH1_PORT          GPIOA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>            GENERAL_TIM_CH1_PIN           GPIO_Pin_6</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">GENERAL_TIM_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h4 id="bsp-pwm-c"><a href="#bsp-pwm-c" class="headerlink" title="bsp_pwm.c"></a>bsp_pwm.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_pwm.h&quot;</span>   </span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">GENERAL_TIM_GPIO_Config</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出比较通道1 GPIO 初始化</span></span><br><span class="line">    RCC_APB2PeriphClockCmd(GENERAL_TIM_CH1_GPIO_CLK, ENABLE);</span><br><span class="line">    GPIO_InitStructure.GPIO_Pin =  GENERAL_TIM_CH1_PIN;</span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;</span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GENERAL_TIM_CH1_PORT, &amp;GPIO_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">GENERAL_TIM_Mode_Config</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 开启定时器时钟,即内部时钟CK_INT=72M</span></span><br><span class="line">	GENERAL_TIM_APBxClock_FUN(GENERAL_TIM_CLK,ENABLE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--------------------时基结构体初始化-------------------------*/</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">    TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 自动重装载寄存器的值，累计TIM_Period+1个频率后产生一个更新或者中断</span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_Period = GENERAL_TIM_Period;	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 驱动CNT计数器的时钟 = Fck_int/(psc+1)</span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_Prescaler = GENERAL_TIM_Prescaler;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 时钟分频因子 ，配置死区时间时需要用到</span></span><br><span class="line">	<span class="comment">// TIM_TimeBaseStructure.TIM_ClockDivision = 0;	</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 计数器计数模式，设置为向上计数</span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 重复计数器的值，没用到不用管</span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_RepetitionCounter=<span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 初始化定时器</span></span><br><span class="line">	TIM_TimeBaseInit(GENERAL_TIM, &amp;TIM_TimeBaseStructure);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*--------------------输出比较结构体初始化-------------------*/</span>	</span><br><span class="line">	<span class="comment">// 占空比配置</span></span><br><span class="line">	<span class="comment">// uint16_t CCR_Val = 100;</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	TIM_OCInitTypeDef  TIM_OCInitStructure;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 配置为PWM模式1</span></span><br><span class="line">	TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 输出使能</span></span><br><span class="line">	TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 输出通道电平极性配置	</span></span><br><span class="line">	TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_Low;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 输出比较通道 1</span></span><br><span class="line">	<span class="comment">//TIM_OCInitStructure.TIM_Pulse = CCR_Val;</span></span><br><span class="line">	</span><br><span class="line">	TIM_OC1Init(GENERAL_TIM, &amp;TIM_OCInitStructure);</span><br><span class="line">	</span><br><span class="line">	TIM_OC1PreloadConfig(GENERAL_TIM, TIM_OCPreload_Enable);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使能计数器</span></span><br><span class="line">	TIM_Cmd(GENERAL_TIM, ENABLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">GENERAL_TIM_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	GENERAL_TIM_GPIO_Config();</span><br><span class="line">	GENERAL_TIM_Mode_Config();		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_pwm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_SysTick.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  主函数</span></span><br><span class="line"><span class="comment">  * @param  无  </span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment">/* 定时器初始化 */</span></span><br><span class="line">	GENERAL_TIM_Init();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 配置SysTick 为10us中断一次 */</span></span><br><span class="line">	SysTick_Init();</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		SysTick_Delay_Ms( <span class="number">1000</span> );</span><br><span class="line">		TIM_SetCompare1(TIM3, <span class="number">175</span>);			<span class="comment">// 0°</span></span><br><span class="line">		SysTick_Delay_Ms( <span class="number">1000</span> );</span><br><span class="line">		TIM_SetCompare1(TIM3, <span class="number">180</span>);			<span class="comment">// 45°</span></span><br><span class="line">		SysTick_Delay_Ms( <span class="number">1000</span> );</span><br><span class="line">		TIM_SetCompare1(TIM3, <span class="number">185</span>);			<span class="comment">// 90°</span></span><br><span class="line">		SysTick_Delay_Ms( <span class="number">1000</span> );</span><br><span class="line">		TIM_SetCompare1(TIM3, <span class="number">190</span>);			<span class="comment">// 135°</span></span><br><span class="line">		SysTick_Delay_Ms( <span class="number">1000</span> );</span><br><span class="line">		TIM_SetCompare1(TIM3, <span class="number">195</span>);			<span class="comment">// 180°</span></span><br><span class="line">		SysTick_Delay_Ms( <span class="number">1000</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="舵机测试"><a href="#舵机测试" class="headerlink" title="舵机测试"></a>舵机测试</h2><img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/Video_20200925_103245_834.gif" alt="舵机测试" style="zoom:220%;" />

</article><div id="paginator"></div></main><footer><div class="icon-wrapper in-left"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></button></div><div class="icon-wrapper in-right"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></span></button></div><p class="copyright-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer">CC BY-NC-SA 4.0</a><span>·</span><a href="https://github.com/ttttonyhe/ouorz-mono" target="_blank" rel="noreferrer">Open Source Software (OSS)</a></p></footer><script src="/js/ouo.js"></script></div></body></html>