<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Android 学习之掉坑记录 [ Mahoo12138 ]</title><link rel="stylesheet" href="/css/index.css"><meta name="post"><link rel="stylesheet" href="/css/layouts/post.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="hexo-container"><header></header><main id="content"><article id="post"><h1>Android 学习之掉坑记录</h1><h2 id="Android8-0及以上版本自定义广播无法接收问题"><a href="#Android8-0及以上版本自定义广播无法接收问题" class="headerlink" title="Android8.0及以上版本自定义广播无法接收问题"></a>Android8.0及以上版本自定义广播无法接收问题</h2><p>今天在学习广播过程中发现，自定义广播无效，由于使用的学习参考书是基于Android7.0的，所以，很自然的想到了可能由于版本问题，网上一查，果然。</p>
<p><strong>原因</strong>：Android8在静态广播的使用上做了一些限制</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/about/versions/oreo/background#broadcasts">广播限制</a>：除了有限的例外情况，应用程序无法使用其清单注册隐式广播。他们仍然可以在运行时注册这些广播，并且他们可以使用清单注册专门针对其应用的显式广播。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/about/versions/oreo/background">https://developer.android.google.cn/about/versions/oreo/background</a></p>
<p><strong>解决方法：</strong></p>
<ul>
<li><p>保留原来的静态广播，但是加入Component参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.mahoo.broadcast.MY_BROADCAST #自定义广播&quot;</span>);</span><br><span class="line">intent.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;com.mahoo.broadcasttest #包名&quot;</span>,<span class="string">&quot;com.mahoo.broadcasttest.MyBroadcastReceiver #广播接收器地址&quot;</span>));</span><br><span class="line">sendBroadcast(intent,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用动态注册广播接收器代替静态注册广播接收器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 暂时不会</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Android8-0及以上系统通知栏的适配"><a href="#Android8-0及以上系统通知栏的适配" class="headerlink" title="Android8.0及以上系统通知栏的适配"></a>Android8.0及以上系统通知栏的适配</h2><p>还是一样原因由于参考书较老旧，出现通知栏适配无效的问题，详细地说是方法已被弃用：</p>
<p><img src="https://cdn.jsdelivr.net/gh/mahoo12138/js-css-cdn/hexo-images/study/Android/notification.png"></p>
<p>从Android 8.0系统开始，Google引入了<strong>通知渠道</strong>这个概念。</p>
<blockquote>
<p>通知渠道，顾名思义，就是每条通知都要属于一个对应的渠道。每个App都可以自由地创建当前App拥有哪些通知渠道，但是这些通知渠道的控制权都是掌握在用户手上的。用户可以自由地选择这些通知渠道的重要程度，是否响铃、是否振动、或者是否要关闭这个渠道的通知。</p>
</blockquote>
<p><strong>解决方法：</strong></p>
<p>创建通知渠道，在构建通知对象的时候，多传入一个通知渠道ID</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NotificationCompat.Builder(Context context, String channelId)</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">channelId</span> <span class="operator">=</span> <span class="string">&quot;chat&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">channelName</span> <span class="operator">=</span> <span class="string">&quot;聊天消息&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">importance</span> <span class="operator">=</span> NotificationManager.IMPORTANCE_HIGH;</span><br><span class="line"><span class="type">NotificationChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationChannel</span>(channelId, channelName,importance);</span><br><span class="line"></span><br><span class="line"><span class="comment">//向系统注册通知渠道，注册后不能改变重要性以及其他通知行为</span></span><br><span class="line"><span class="type">NotificationManager</span> <span class="variable">notificationmanager</span> <span class="operator">=</span> (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//构建通知渠道</span></span><br><span class="line">notificationManager.createNotificationChannel(channel);</span><br><span class="line"></span><br><span class="line"><span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;chat&quot;</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;收到一条聊天消息&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;通知栏适配成功了&quot;</span>)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.drawable.icon)</span><br><span class="line">    			.setLargeIcon(BitmapFactory.decodeResource(getResources(),</span><br><span class="line">                	R.drawable.icon))</span><br><span class="line">                .setAutoCancel(<span class="literal">true</span>)	<span class="comment">//设置点击取消通知</span></span><br><span class="line">                .build();</span><br><span class="line">manager.notify(<span class="number">1</span>, notification);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注：</strong>例子参考于<a target="_blank" rel="noopener" href="https://blog.csdn.net/guolin_blog/article/details/79854070">Android通知栏微技巧，8.0系统中通知栏的适配</a></p>
<h2 id="Android9-0无法加载http的url"><a href="#Android9-0无法加载http的url" class="headerlink" title="Android9.0无法加载http的url"></a>Android9.0无法加载http的url</h2><p>因为从Android 9.0（API级别28）开始，默认情况下限制了明文流量的网络请求，对未加密流量不再信任，直接放弃请求。即http的url均无法在webview中加载，且报错为<code>net::ERR_CLEARTEXT_NOT_PERMITTED</code>。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li><p><del>在<code>AndroidManifest.xml</code>中打开开关</del></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>res 下新建 xml 目录，创建文件：<code>network_security_config.xml</code> ，内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 AndroidManifest.xml 的 <code>application</code> 标签添加配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:networkSecurityConfig</span>=<span class="string">&quot;@xml/network_security_config&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安卓8-0以上前台服务通知栏常驻"><a href="#安卓8-0以上前台服务通知栏常驻" class="headerlink" title="安卓8.0以上前台服务通知栏常驻"></a>安卓8.0以上前台服务通知栏常驻</h2><p>这里有个小坑，在9.0中前台服务必须授予FOREGROUND_SERVICE权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.FOREGROUND_SERVICE&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>具体直接查看代码：<a target="_blank" rel="noopener" href="https://github.com/Mahoo12138/android_learn_demo/tree/master/ServiceTest">Android_Service_Demo</a></p>
<h2 id="在webview中唤醒QQ实现程序的反馈"><a href="#在webview中唤醒QQ实现程序的反馈" class="headerlink" title="在webview中唤醒QQ实现程序的反馈"></a>在webview中唤醒QQ实现程序的反馈</h2><p>重载<code>shouldOverrideUrlLoading</code>方法，因为网页一般调用QQ使用<em><a target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=QQ%E5%8F%B7&site=qq&menu=yes">http://wpa.qq.com/msgrd?v=3&amp;uin=QQ号&amp;site=qq&amp;menu=yes</a></em>，通过抓包发现，实际还发送了一个这样的请求<em>mqqwpa:&#x2F;&#x2F;im&#x2F;chat</em>，此时用一个intent调用QQ即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, WebResourceRequest request)</span> &#123;</span><br><span class="line">    	<span class="keyword">if</span> (request.getUrl().toString().startsWith(<span class="string">&quot;http&quot;</span>) ||request.getUrl().toString().startsWith(<span class="string">&quot;https&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, request);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW,Uri.parse(request.getUrl().toString())));</span><br><span class="line">                    startActivity(intent);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        webView.loadUrl(url);</span><br><span class="line">        finish();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div id="paginator"></div></main><footer><div class="icon-wrapper in-left"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></button></div><div class="icon-wrapper in-right"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></span></button></div><p class="copyright-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer">CC BY-NC-SA 4.0</a><span>·</span><a href="https://github.com/ttttonyhe/ouorz-mono" target="_blank" rel="noreferrer">Open Source Software (OSS)</a></p></footer><script src="/js/ouo.js"></script></div></body></html>