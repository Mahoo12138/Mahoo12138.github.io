<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>宝塔 nginx 配置 webdav 服务器 [ Mahoo12138 ]</title><link rel="stylesheet" href="/css/index.css"><meta name="post"><link rel="stylesheet" href="/css/layouts/post.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="hexo-container"><header></header><main id="content"><article id="post"><h1>宝塔 nginx 配置 webdav 服务器</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>近年来，我一直在做一件事，就是将自己的数据，脱离那些商业公司，使用自己部署的备份，最次也是使用国外大厂的备份，国内厂商我已经对其毫无兴趣了，目前图片之类是备份在 <strong>咕噜咕噜</strong> 家的 Drive ，而其他 app 应用产生的数据，如我的心情日记，账本，文字笔记之类的都在巨硬的 Onedrive ，之前都是使用国内坚果云的 Webdav 服务进行同步，而我也已经准备抛弃他了，转向自己搭建 webdav 服务器，于是有了这篇文章。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>由于我的服务器（Mido 旧手机搭建）使用的是宝塔的一揽子服务，在安装时我选择的是 nginx ，自然而然地，<code>WebDAV</code>也是基于<code>Nginx</code>搭建的，Webdav 服务需要<code>Nginx</code>的<code>http_dav_module</code>模块支持；</p>
<p>可以使用使用指令：<code>nginx -V</code> 查询已安装的 nginx 是否已经内置了<code>http_dav_module</code>模块，如果出现了如下字眼：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--add-module=/www/server/nginx/src/nginx-dav-ext-module</span><br></pre></td></tr></table></figure>

<p>说明已经内置，无需额外安装；如果没有，则重新安装<code>Nginx</code>，且需要添加自定义模块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">模块名称：http_dav_module</span><br><span class="line">模块描述：webdev</span><br><span class="line">模块参数：--with-http_dav_module --add-module=/root/nginx-dav-ext-module</span><br><span class="line">前置脚本：git clone https://github.com/arut/nginx-dav-ext-module.git /root/nginx-dav-ext-module</span><br></pre></td></tr></table></figure>

<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><p>nginx 配置依赖好后，就可以开始搭建服务了。在【网站】一栏中，新建一个网站，添加时<code>PHP版本</code>选择<code>纯静态</code>，<code>WebDAV</code>并不需要任何<code>PHP</code>支持；</p>
<p>最后需要修改站点的<code>Nginx</code>配置文件，可以直接在【配置文件】中配置，也可以在反向代理中，个人由于多个服务都走的同一个域名，也就是这个新建的网站，只是用来代理服务，所以统一是在反向代理进行配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /dav/</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">alias</span> /root/workbench/data/dav/;			<span class="comment"># Webdav 服务根目录</span></span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$dest</span> <span class="variable">$http_destination</span>;</span><br><span class="line">    <span class="attribute">if</span> (-d <span class="variable">$request_filename</span>) &#123;                   <span class="comment"># 对目录请求、对URI自动添加&quot;/&quot;</span></span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.*[^/])$</span> <span class="variable">$1</span>/;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$dest</span> <span class="variable">$dest</span>/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if ($request_method ~ (MOVE|COPY)) &#123; # 对MOVE|COPY方法强制添加Destination请求头</span></span><br><span class="line">    <span class="comment">#     add_header  Destination: $dest;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~ MKCOL)</span> &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.*[^/])$</span> <span class="variable">$1</span>/ <span class="literal">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">dav_methods</span>             PUT DELETE MKCOL COPY MOVE;       <span class="comment"># DAV支持的请求方法</span></span><br><span class="line">    <span class="attribute">dav_ext_methods</span>         PROPFIND OPTIONS;     			 <span class="comment"># DAV扩展支持的请求方法</span></span><br><span class="line">    <span class="comment"># dav_ext_lock            zone=davlock;                   # DAV扩展锁绑定的内存区域</span></span><br><span class="line">    <span class="attribute">client_max_body_size</span>    <span class="number">0M</span>;</span><br><span class="line">    <span class="attribute">create_full_put_path</span>    <span class="literal">on</span>;                               <span class="comment"># 启用创建目录支持</span></span><br><span class="line">    <span class="attribute">dav_access</span>              user:rw group:r all:r;            <span class="comment"># 设置创建的文件及目录的访问权限</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">auth_basic</span>              <span class="string">&quot;Authorized Users WebDAV&quot;</span>;</span><br><span class="line">    <span class="attribute">auth_basic_user_file</span>    /root/workbench/config/.passwords.list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后两个配置项，可以提一提，<code>auth_basic</code> 开启使用“HTTP基本认证”（HTTP Basic Authentication）协议的用户名密码验证。<code>auth_basic_user_file</code>：指定保存用户名密码的文件，可使用 openssl 生成密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd 12345</span><br></pre></td></tr></table></figure>

<p>然后以如下格式存储：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name:password</span><br></pre></td></tr></table></figure>

<h2 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h2><p>搭建好 Webdav 后，在安卓客户端中，部分 app 访问会报错 405 not allowed，很离谱，查询了网上的资料后，从相关 <a target="_blank" rel="noopener" href="https://github.com/PhilippC/keepass2android/issues/747">issue </a>中了解到，是安卓开发中一个 http 请求库 okhttp 对 http2 兼容存在问题，建议使用 http1.1 访问，然而大部分的 app 都无法配置请求方式，只能从本地服务器入手了，需要禁用 nginx 的 http2 模式，当然禁用某一个，例如这个搭建 Webdav 的网站是不行的，需要所有网站都关闭 http2，nginx 才完全关闭 http2。</p>
</article><div id="paginator"></div></main><footer><div class="icon-wrapper in-left"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></button></div><div class="icon-wrapper in-right"><button class="icon-button" aria-label="change theme"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" height="100%" width="100%"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></span></button></div><p class="copyright-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer">CC BY-NC-SA 4.0</a><span>·</span><a href="https://github.com/ttttonyhe/ouorz-mono" target="_blank" rel="noreferrer">Open Source Software (OSS)</a></p></footer><script src="/js/ouo.js"></script></div></body></html>